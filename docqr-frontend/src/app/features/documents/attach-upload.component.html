<div class="min-h-screen bg-background-light flex">
  <app-sidebar 
    [isOpen]="sidebarOpen"
    (closeSidebar)="onCloseSidebar()">
  </app-sidebar>

  <div class="flex-1 flex flex-col min-w-0 overflow-hidden">
    <app-header (toggleSidebar)="onToggleSidebar()"></app-header>

    <main class="flex-1 overflow-y-auto p-6">
      <!-- Header -->
      <div class="mb-6">
        <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
          <div>
            <h1 class="text-3xl font-bold text-gray-900">Adjuntar PDF</h1>
            <p class="text-base text-gray-600 mt-1">
              Sube el PDF final para esta carpeta. El archivo se guardará tal cual, sin procesar.
            </p>
          </div>
          <div class="flex items-center gap-3">
            <button 
              type="button"
              (click)="cancelAndReturn()"
              [disabled]="isUploading || isSaving"
              class="px-4 py-2 rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed">
              <span class="material-symbols-outlined text-lg mr-2 align-middle">close</span>
              Cancelar
            </button>
            
            <button 
              type="button"
              (click)="saveAndFinish()"
              [disabled]="!document?.pdf_url || isUploading || isSaving"
              class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-primary-dark transition-all font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:scale-[1.02] hover:shadow-lg hover:shadow-primary/30 active:scale-95">
              <span *ngIf="!isSaving" class="material-symbols-outlined text-lg mr-2 align-middle">save</span>
              <span *ngIf="isSaving" class="material-symbols-outlined text-lg mr-2 align-middle animate-spin">sync</span>
              {{ isSaving ? 'Guardando...' : 'Guardar y Finalizar' }}
            </button>
          </div>
        </div>

        <!-- Información de la Carpeta -->
        <div *ngIf="document" class="bg-white rounded-lg border border-gray-200 p-4 mb-6">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <p class="text-xs font-medium text-gray-500 mb-1">Código</p>
              <p class="text-sm font-semibold text-gray-900">{{ document.folder_name }}</p>
            </div>
            <div>
              <p class="text-xs font-medium text-gray-500 mb-1">Archivo</p>
              <p class="text-sm text-gray-900">{{ document.original_filename || 'Sin archivo' }}</p>
            </div>
            <div>
              <p class="text-xs font-medium text-gray-500 mb-1">Estado</p>
              <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                    [ngClass]="{
                      'bg-green-100 text-green-800': document.status === 'completed',
                      'bg-yellow-100 text-yellow-800': document.status === 'uploaded',
                      'bg-gray-100 text-gray-800': document.status === 'pending'
                    }">
                {{ document.status === 'completed' ? 'Completado' : 
                   document.status === 'uploaded' ? 'Subido' : 'Pendiente' }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Contenido Principal -->
      <div *ngIf="loading" class="flex items-center justify-center py-12">
        <div class="text-center">
          <span class="material-symbols-outlined text-6xl text-gray-400 animate-spin mb-4">sync</span>
          <p class="text-gray-600">Cargando carpeta...</p>
        </div>
      </div>

      <div *ngIf="!loading && document" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Columna Izquierda: QR -->
        <div class="bg-white rounded-lg border border-gray-200 p-6">
          <h2 class="text-xl font-bold text-gray-900 mb-4">Código QR</h2>
          
          <!-- Imagen del QR -->
          <div class="flex flex-col items-center justify-center mb-6 p-6 bg-gray-50 rounded-lg">
            <img 
              *ngIf="qrImageUrlWithCache"
              [src]="qrImageUrlWithCache" 
              [alt]="'QR ' + document.qr_id"
              class="w-64 h-64 object-contain transition-opacity duration-300">
            <p *ngIf="!document.qr_image_url" class="text-gray-500">QR no disponible</p>
          </div>

          <!-- Botones de acción del QR -->
          <div class="flex flex-col gap-3">
            <button
              type="button"
              (click)="copyQrUrl()"
              [disabled]="!document.qr_image_url"
              class="flex items-center justify-center gap-2 px-4 py-3 rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 transition-all duration-200 font-medium disabled:opacity-50 disabled:cursor-not-allowed active:scale-95 hover:shadow-md">
              <span class="material-symbols-outlined transition-transform duration-200 hover:scale-110">content_copy</span>
              Copiar QR
            </button>
            <button
              type="button"
              (click)="downloadQr()"
              [disabled]="!document.qr_image_url"
              class="flex items-center justify-center gap-2 px-4 py-3 rounded-lg border border-primary bg-primary text-white hover:bg-primary/90 transition-all duration-200 font-medium disabled:opacity-50 disabled:cursor-not-allowed active:scale-95 hover:shadow-lg hover:shadow-primary/30">
              <span class="material-symbols-outlined transition-transform duration-200 hover:scale-110">download</span>
              Descargar QR
            </button>
          </div>

          <!-- URL del QR -->
          <div class="mt-4 p-3 bg-gray-50 rounded-lg">
            <div class="flex items-center justify-between mb-1">
              <p class="text-xs font-medium text-gray-500">URL del QR</p>
              <button
                type="button"
                (click)="copyQrUrlToClipboard()"
                [disabled]="!document.qr_url"
                class="p-1.5 rounded-md hover:bg-gray-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                title="Copiar URL">
                <span class="material-symbols-outlined text-gray-600 text-base">content_copy</span>
              </button>
            </div>
            <p class="text-xs text-gray-700 break-all">{{ document.qr_url || 'No disponible' }}</p>
          </div>
        </div>

        <!-- Columna Derecha: Subir PDF -->
        <div class="bg-white rounded-lg border border-gray-200 p-6">
          <h2 class="text-xl font-bold text-gray-900 mb-4">Subir PDF Final</h2>

          <!-- PDF existente (si hay) -->
          <div *ngIf="document.pdf_url" class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
            <div class="flex items-center gap-3 mb-2">
              <span class="material-symbols-outlined text-blue-600">picture_as_pdf</span>
              <p class="text-sm font-medium text-blue-900">PDF actual: {{ document.original_filename }}</p>
            </div>
            <p class="text-xs text-blue-800 mb-3">Puedes reemplazarlo subiendo un nuevo archivo.</p>
            <a 
              [href]="document.pdf_url" 
              target="_blank"
              class="text-xs text-blue-600 hover:text-blue-800 underline">
              Ver PDF actual
            </a>
          </div>

          <!-- Área de drag & drop -->
          <div
            class="flex flex-col items-center gap-4 rounded-lg border-2 border-dashed px-6 py-10 transition-all duration-300 cursor-pointer hover:border-primary hover:bg-primary hover:bg-opacity-5 mb-4 hover:scale-[1.02] active:scale-[0.98]"
            [ngClass]="{
              'border-primary bg-primary bg-opacity-10 scale-[1.02]': dragOver,
              'border-gray-300': !dragOver
            }"
            (dragover)="onDragOver($event)"
            (dragleave)="onDragLeave($event)"
            (drop)="onDrop($event)"
            (click)="fileInput.click()">
            
            <div class="flex h-16 w-16 items-center justify-center rounded-full bg-primary bg-opacity-10 transition-all duration-300 hover:scale-110 hover:bg-opacity-20 hover:rotate-3">
              <span class="material-symbols-outlined text-primary text-4xl transition-transform duration-300 hover:scale-110">upload_file</span>
            </div>

            <div class="text-center">
              <p class="text-base font-bold text-gray-900 mb-2">
                Arrastra y suelta tu archivo PDF aquí
              </p>
              <p class="text-sm text-gray-600 mb-4">
                o elige un archivo de tu computadora
              </p>
              <div class="btn-primary transition-all duration-200 hover:scale-105 active:scale-95 hover:shadow-md">
                Seleccionar Archivo
              </div>
              <input
                #fileInput
                id="file-input"
                type="file"
                accept=".pdf"
                class="hidden"
                (change)="onFileSelected($event)">
            </div>
          </div>

          <!-- Archivo seleccionado -->
          <div *ngIf="selectedFile" class="mb-4 rounded-lg border border-gray-200 p-4 bg-gray-50">
            <div class="flex items-center gap-4 justify-between mb-3">
              <div class="flex items-center gap-4 flex-1 min-w-0">
                <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-primary bg-opacity-10 text-primary">
                  <span class="material-symbols-outlined text-2xl">picture_as_pdf</span>
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium text-gray-900 truncate">
                    {{ selectedFile.name }}
                  </p>
                  <p class="text-xs text-gray-500">
                    {{ (selectedFile.size / (1024 * 1024)).toFixed(2) }} MB
                  </p>
                </div>
              </div>
              <button
                type="button"
                (click)="removeFile()"
                [disabled]="isUploading"
                class="shrink-0 hover:text-red-500 transition-colors disabled:opacity-50">
                <span class="material-symbols-outlined text-2xl">close</span>
              </button>
            </div>

            <!-- Barra de progreso -->
            <div *ngIf="isUploading" class="flex flex-col gap-2">
              <p class="text-sm font-medium text-gray-800">Subiendo...</p>
              <div class="rounded-full bg-gray-200 h-2">
                <div
                  class="h-2 rounded-full bg-primary transition-all duration-300"
                  [style.width.%]="uploadProgress">
                </div>
              </div>
            </div>
          </div>

          <!-- Botón de subir -->
          <button
            type="button"
            (click)="uploadPdf()"
            [disabled]="!selectedFile || isUploading"
            class="w-full btn-primary disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 active:scale-95 hover:scale-[1.02] hover:shadow-lg hover:shadow-primary/30 disabled:active:scale-100 disabled:hover:scale-100">
            <span *ngIf="!isUploading" class="material-symbols-outlined text-lg mr-2 align-middle transition-transform duration-200">upload</span>
            <span *ngIf="isUploading" class="material-symbols-outlined text-lg mr-2 align-middle animate-spin">sync</span>
            {{ isUploading ? 'Subiendo...' : (document.pdf_url ? 'Reemplazar PDF' : 'Subir PDF') }}
          </button>

          <!-- Información -->
          <div class="mt-4 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
            <div class="flex items-start gap-2">
              <span class="material-symbols-outlined text-yellow-600 text-sm">info</span>
              <p class="text-xs text-yellow-800">
                El PDF se guardará tal cual, sin procesar ni modificar. Ideal para documentos multipágina o complejos.
              </p>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>
</div>

