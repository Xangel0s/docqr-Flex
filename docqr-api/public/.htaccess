<IfModule mod_rewrite.c>
    <IfModule mod_negotiation.c>
        Options -MultiViews -Indexes
    </IfModule>

    RewriteEngine On

    # ============================================
    # SEGURIDAD: Protección de archivos sensibles
    # ============================================
    
    # Bloquear acceso a archivos .env y otros sensibles
    <FilesMatch "^\.env|^\.git|composer\.(json|lock)|package(-lock)?\.json|\.md$">
        Require all denied
    </FilesMatch>

    # Bloquear acceso directo a directorios del framework
    RewriteRule ^(app|bootstrap|config|database|resources|routes|storage|tests|vendor)/ - [F,L]

    # Proteger archivos PHP sensibles
    <FilesMatch "^(artisan|phpunit\.xml|server\.php|webpack\.mix\.js)$">
        Require all denied
    </FilesMatch>

    # ============================================
    # SEGURIDAD: Headers HTTP
    # ============================================

    <IfModule mod_headers.c>
        # Prevenir MIME sniffing
        Header always set X-Content-Type-Options "nosniff"
        
        # Protección XSS básica (navegadores antiguos)
        Header always set X-XSS-Protection "1; mode=block"
        
        # Prevenir clickjacking (el middleware puede sobrescribir esto)
        Header always set X-Frame-Options "SAMEORIGIN"
        
        # Control de Referrer
        Header always set Referrer-Policy "no-referrer-when-downgrade"
        
        # Ocultar información del servidor
        Header unset X-Powered-By
        Header always unset X-Powered-By
        
        # HSTS - Forzar HTTPS (solo si usas SSL)
        # Descomenta la siguiente línea si tienes SSL configurado
        # Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" env=HTTPS
    </IfModule>

    # ============================================
    # RENDIMIENTO: Compresión GZIP
    # ============================================

    <IfModule mod_deflate.c>
        # Comprimir HTML, CSS, JavaScript, Text, XML y fuentes
        AddOutputFilterByType DEFLATE application/javascript
        AddOutputFilterByType DEFLATE application/json
        AddOutputFilterByType DEFLATE application/rss+xml
        AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
        AddOutputFilterByType DEFLATE application/x-font-ttf
        AddOutputFilterByType DEFLATE application/x-javascript
        AddOutputFilterByType DEFLATE application/xhtml+xml
        AddOutputFilterByType DEFLATE application/xml
        AddOutputFilterByType DEFLATE font/opentype
        AddOutputFilterByType DEFLATE font/otf
        AddOutputFilterByType DEFLATE font/ttf
        AddOutputFilterByType DEFLATE image/svg+xml
        AddOutputFilterByType DEFLATE image/x-icon
        AddOutputFilterByType DEFLATE text/css
        AddOutputFilterByType DEFLATE text/html
        AddOutputFilterByType DEFLATE text/javascript
        AddOutputFilterByType DEFLATE text/plain
        AddOutputFilterByType DEFLATE text/xml

        # Remover encabezado ETag (conflicto con compresión)
        <IfModule mod_headers.c>
            Header unset ETag
        </IfModule>
        FileETag None
    </IfModule>

    # ============================================
    # RENDIMIENTO: Cache de recursos estáticos
    # ============================================

    <IfModule mod_expires.c>
        ExpiresActive On
        
        # Imágenes
        ExpiresByType image/jpg "access plus 1 year"
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/gif "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 year"
        ExpiresByType image/webp "access plus 1 year"
        ExpiresByType image/x-icon "access plus 1 year"
        
        # CSS y JavaScript
        ExpiresByType text/css "access plus 1 month"
        ExpiresByType application/javascript "access plus 1 month"
        ExpiresByType text/javascript "access plus 1 month"
        
        # Fuentes
        ExpiresByType font/ttf "access plus 1 year"
        ExpiresByType font/otf "access plus 1 year"
        ExpiresByType font/woff "access plus 1 year"
        ExpiresByType font/woff2 "access plus 1 year"
        ExpiresByType application/font-woff "access plus 1 year"
        
        # HTML (sin cache)
        ExpiresByType text/html "access plus 0 seconds"
        
        # JSON (sin cache)
        ExpiresByType application/json "access plus 0 seconds"
        
        # PDF
        ExpiresByType application/pdf "access plus 1 month"
    </IfModule>

    # Cache-Control alternativo si mod_expires no está disponible
    <IfModule mod_headers.c>
        <FilesMatch "\.(jpg|jpeg|png|gif|webp|svg|ico)$">
            Header set Cache-Control "max-age=31536000, public"
        </FilesMatch>
        <FilesMatch "\.(css|js)$">
            Header set Cache-Control "max-age=2592000, public"
        </FilesMatch>
        <FilesMatch "\.(woff|woff2|ttf|otf|eot)$">
            Header set Cache-Control "max-age=31536000, public"
        </FilesMatch>
    </IfModule>

    # ============================================
    # SEGURIDAD: Prevenir hotlinking de imágenes
    # ============================================

    # Descomenta y ajusta el dominio para prevenir hotlinking
    # RewriteCond %{HTTP_REFERER} !^$
    # RewriteCond %{HTTP_REFERER} !^https?://(www\.)?docqr\.geofal\.com\.pe [NC]
    # RewriteRule \.(jpg|jpeg|png|gif|webp|svg)$ - [F,L]

    # ============================================
    # LARAVEL: Manejo de Authorization Header
    # ============================================

    RewriteCond %{HTTP:Authorization} .
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

    # ============================================
    # LARAVEL: Redireccionar trailing slashes
    # ============================================

    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} (.+)/$
    RewriteRule ^ %1 [L,R=301]

    # ============================================
    # APLICACIÓN: Rutas de la API
    # ============================================

    # API Routes - Enviar a Laravel
    RewriteCond %{REQUEST_URI} ^/api
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^ index.php [L]

    # ============================================
    # APLICACIÓN: Archivos estáticos del frontend
    # ============================================

    # Servir archivos estáticos del frontend (JS, CSS, imágenes, etc.)
    RewriteCond %{REQUEST_URI} ^/(.*\.(js|css|ico|png|jpg|jpeg|gif|svg|woff|woff2|ttf|eot|json|map))$
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^(.*)$ frontend/$1 [L]

    # ============================================
    # APLICACIÓN: Health Check Endpoint
    # ============================================

    # Health Check - Enviar /up a Laravel
    RewriteCond %{REQUEST_URI} ^/up$
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^ index.php [L]

    # ============================================
    # APLICACIÓN: Frontend Angular (SPA)
    # ============================================

    # Frontend Angular (SPA) - Servir index.html para todas las rutas no-API
    RewriteCond %{REQUEST_URI} !^/api
    RewriteCond %{REQUEST_URI} !^/up
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_URI} !^/frontend
    RewriteRule ^ frontend/index.html [L]

    # Servir archivos del frontend directamente (fallback para routing SPA)
    RewriteCond %{REQUEST_URI} ^/frontend
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^frontend/(.*)$ frontend/index.html [L]

    # ============================================
    # SEGURIDAD: Limitar métodos HTTP
    # ============================================

    # Permitir solo métodos necesarios
    <LimitExcept GET POST PUT DELETE PATCH OPTIONS HEAD>
        Require all denied
    </LimitExcept>

</IfModule>

# ============================================
# SEGURIDAD: Protección adicional sin mod_rewrite
# ============================================

<IfModule !mod_rewrite.c>
    # Si mod_rewrite no está disponible, al menos proteger archivos sensibles
    <FilesMatch "^\.env">
        Require all denied
    </FilesMatch>
</IfModule>

# ============================================
# PHP: Configuración de seguridad básica
# ============================================

# Si el servidor lo permite, desactivar display_errors
# php_flag display_errors Off
# php_flag log_errors On
# php_value error_log /path/to/logs/php-error.log
