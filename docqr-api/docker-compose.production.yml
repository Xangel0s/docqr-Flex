# ====================================
# Docker Compose para Producción
# DocQR-Flex - Sistema completo
# ====================================
#
# IMPORTANTE:
# 1. Crear archivo .env.production con todas las variables
# 2. Ajustar volúmenes según rutas del servidor
# 3. Configurar backups automáticos de volúmenes
# 4. Monitorear logs y métricas
#

version: '3.8'

# ====================================
# SERVICIOS
# ====================================

services:
  # ====================================
  # API Backend (Laravel)
  # ====================================
  api:
    build:
      context: .
      dockerfile: Dockerfile.production
    container_name: docqr-api
    restart: unless-stopped
    
    # Variables de entorno (usar archivo .env.production)
    env_file:
      - .env.production
    
    # Redes
    networks:
      - docqr-network
    
    # Puertos
    ports:
      - "8080:80"
    
    # Volúmenes persistentes
    volumes:
      # Uploads y QR (CRÍTICO: persistentes)
      - uploads-data:/var/www/html/storage/app/uploads
      - qr-data:/var/www/html/storage/app/qr
      # Logs (para debugging)
      - logs-data:/var/www/html/storage/logs
      # Cache de Laravel
      - cache-data:/var/www/html/storage/framework/cache
    
    # Dependencias
    depends_on:
      - db
      - redis
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/up"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Límites de recursos
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ====================================
  # Base de Datos (MySQL)
  # ====================================
  db:
    image: mysql:8.0
    container_name: docqr-db
    restart: unless-stopped
    
    # Variables de entorno
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-root_password_change_me}
      MYSQL_DATABASE: ${DB_DATABASE:-docqr}
      MYSQL_USER: ${DB_USERNAME:-docqr_user}
      MYSQL_PASSWORD: ${DB_PASSWORD:-change_me}
      MYSQL_CHARSET: utf8mb4
      MYSQL_COLLATION: utf8mb4_unicode_ci
    
    # Redes
    networks:
      - docqr-network
    
    # Puertos (comentar en producción si no se necesita acceso externo)
    # ports:
    #   - "3306:3306"
    
    # Volúmenes persistentes
    volumes:
      - db-data:/var/lib/mysql
      - ./database/sql:/docker-entrypoint-initdb.d:ro
    
    # Configuración MySQL optimizada
    command: 
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --max-connections=200
      - --innodb-buffer-pool-size=256M
      - --innodb-log-file-size=64M
    
    # Health check
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    # Límites de recursos
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ====================================
  # Redis (Cache y Sesiones)
  # ====================================
  redis:
    image: redis:7-alpine
    container_name: docqr-redis
    restart: unless-stopped
    
    # Redes
    networks:
      - docqr-network
    
    # Puertos (comentar en producción)
    # ports:
    #   - "6379:6379"
    
    # Volúmenes persistentes
    volumes:
      - redis-data:/data
    
    # Configuración Redis
    command: >
      redis-server
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
    
    # Health check
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    
    # Límites de recursos
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

  # ====================================
  # Nginx (Reverse Proxy & Frontend)
  # ====================================
  nginx:
    image: nginx:1.25-alpine
    container_name: docqr-nginx
    restart: unless-stopped
    
    # Redes
    networks:
      - docqr-network
    
    # Puertos
    ports:
      - "80:80"
      - "443:443"
    
    # Volúmenes
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./public/frontend:/usr/share/nginx/html/frontend:ro
      - ./docker/ssl:/etc/nginx/ssl:ro
      - nginx-logs:/var/log/nginx
    
    # Dependencias
    depends_on:
      - api
    
    # Health check
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    
    # Límites de recursos
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

# ====================================
# REDES
# ====================================

networks:
  docqr-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# ====================================
# VOLÚMENES PERSISTENTES
# ====================================

volumes:
  # Base de datos (CRÍTICO: hacer backups regulares)
  db-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/docqr/data/mysql

  # Archivos subidos (CRÍTICO: hacer backups regulares)
  uploads-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/docqr/data/uploads

  # Códigos QR generados
  qr-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/docqr/data/qr

  # Redis cache
  redis-data:
    driver: local

  # Logs de Laravel
  logs-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/docqr/logs

  # Cache de Laravel
  cache-data:
    driver: local

  # Logs de Nginx
  nginx-logs:
    driver: local

# ====================================
# NOTAS DE DESPLIEGUE
# ====================================
#
# INICIAR SERVICIOS:
# docker-compose -f docker-compose.production.yml up -d
#
# VER LOGS:
# docker-compose -f docker-compose.production.yml logs -f
#
# DETENER SERVICIOS:
# docker-compose -f docker-compose.production.yml down
#
# REINICIAR UN SERVICIO:
# docker-compose -f docker-compose.production.yml restart api
#
# EJECUTAR COMANDOS EN CONTENEDOR:
# docker-compose -f docker-compose.production.yml exec api php artisan migrate
# docker-compose -f docker-compose.production.yml exec api php artisan config:cache
#
# BACKUP DE BASE DE DATOS:
# docker-compose -f docker-compose.production.yml exec db mysqldump -u root -p docqr > backup.sql
#
# RESTAURAR BACKUP:
# docker-compose -f docker-compose.production.yml exec -T db mysql -u root -p docqr < backup.sql
#
# CREAR DIRECTORIOS ANTES DEL PRIMER DESPLIEGUE:
# mkdir -p /opt/docqr/data/{mysql,uploads,qr}
# mkdir -p /opt/docqr/logs
# chown -R 1000:1000 /opt/docqr
#
# CONFIGURAR SSL (Let's Encrypt):
# 1. Instalar certbot
# 2. Obtener certificado: certbot certonly --webroot -w /opt/docqr/public -d docqr.geofal.com.pe
# 3. Copiar certificados a ./docker/ssl/
# 4. Descomentar puerto 443 en nginx
#
